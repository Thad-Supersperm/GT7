<!DOCTYPE html>
<html lang="en">
<head>
    <title>GT7 Carlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; }
        table, th, td { border: 1px solid black; border-collapse: collapse; padding: 4px; vertical-align: top;}
        #main-table tbody tr:nth-child(even) { background-color: #D6EEEE; }
        p { white-space: nowrap; display: block; margin: 2px 0; }
        div.own-cell { font-weight: bold; }
        .q { vertical-align: bottom; border: none; }
        .n::before, .z::before, .t::before { content: "\25CE"; } /* Empty Circle */
        .o::before { content: "\25CF"; } /* Full Circle */
        .c::before, .v::before, .y::before { content: "\25C9"; } /* Fisheye */
        #main-table thead th { cursor: pointer; user-select: none; }
        .price { text-align: right; }
        .car-make-header { text-align: center; background-color: #c0c0c0; font-size: 1.2em; }
    </style>
</head>
<body>
    <div id="header-container"></div>
    <br>
    <!-- The summary tables are complex and would require their own data sources. This part is omitted for now. -->
    <br>
    <p>
      <b style="font-size: 1.5em; font-weight: bold;">Tags:</b>
      <!-- Tag definitions remain the same -->
       <b style="font-size: 1.2em; font-weight: bold;">Ro</b>=Road Car; 
       <b style="font-size: 1.2em; font-weight: bold;">Ra</b>=Racing Car; 
       <b style="font-size: 1.2em; font-weight: bold;">PT</b>=Professionally Tuned; 
       <b style="font-size: 1.2em; font-weight: bold;">CC</b>=Concept Car; 
       <b style="font-size: 1.2em; font-weight: bold;">EC</b>=Electric Car; 
       <b style="font-size: 1.2em; font-weight: bold;">Hb</b>=Hybrid Car; 
       <b style="font-size: 1.2em; font-weight: bold;">Hp</b>=Hypercar; 
       <b style="font-size: 1.2em; font-weight: bold;">KC</b>=Kei Car; 
       <b style="font-size: 1.2em; font-weight: bold;">SC</b>=Safety Car; 
       <b style="font-size: 1.2em; font-weight: bold;">PU</b>=Pickup Truck; 
       <b style="font-size: 1.2em; font-weight: bold;">Kt</b>=Kart; 
       <b style="font-size: 1.2em; font-weight: bold;">MS</b>=Midship; 
       <b style="font-size: 1.2em; font-weight: bold;">VG</b>=Vision Gran Turismo; 
       <b style="font-size: 1.2em; font-weight: bold;">GA</b>=Gran Turismo Award; 
       <b style="font-size: 1.2em; font-weight: bold;">GT</b>=Gran Turismo Trophy; 
       <b style="font-size: 1.2em; font-weight: bold;">G3</b>=GT300; 
       <b style="font-size: 1.2em; font-weight: bold;">G5</b>=GT500; 
       <b style="font-size: 1.2em; font-weight: bold;">LM</b>=Le Mans; 
       <b style="font-size: 1.2em; font-weight: bold;">N24</b>=NÃ¼rburgring 24 Hours; 
       <b style="font-size: 1.2em; font-weight: bold;">PP</b>=Pikes Peak; 
       <b style="font-size: 1.2em; font-weight: bold;">WRC</b>=WRC
    </p><br>
    <table id="main-table" style="width:100%;">
        <thead>
            <tr id="0">
                <th colspan="14">
                    <div style="float: left; width: 33%;"><span style="font-size: 1.5em; font-weight: bold;">Collection: </span><span style="font-size: 1.5em; font-weight: bold;" id="a_o"></span><span style="font-size: 1.5em; font-weight: bold;">/</span><span style="font-size: 1.5em; font-weight: bold;" id="a_"></span></div>
                    <div style="display: inline-block; width: 33%;"><span style="font-size: 1.5em; font-weight: bold;">Variations: </span><span style="font-size: 1.5em; font-weight: bold;" id="z_v"></span><span style="font-size: 1.5em; font-weight: bold;">/</span><span style="font-size: 1.5em; font-weight: bold;" id="z_"></span></div>
                    <div style="float: right; width: 33%;"><span style="font-size: 1.5em; font-weight: bold;">Complete sets: </span><span style="font-size: 1.5em; font-weight: bold;" id="a_c"></span></div>
                </th>
                <th colspan="6"><span style="font-size: 1.5em; font-weight: bold;">Tuning Settings</span></th>
            </tr>
            <tr id="00">
                <th onclick="sortTable(0)">#</th>
                <th onclick="sortTable(1)">C</th>
                <th onclick="sortTable(2)">Year</th>
                <th onclick="sortTable(3)">Make</th>
                <th onclick="sortTable(4)">Model</th>
                <th onclick="sortTable(5)">Layt</th>
                <th onclick="sortTable(6)">Asp</th>
                <th onclick="sortTable(7)">PP</th>
                <th onclick="sortTable(8)">New</th>
                <th onclick="sortTable(9)">Legend</th>
                <th onclick="sortTable(10)">Used</th>
                <th onclick="sortTable(11)">Tags</th>
                <th onclick="sortTable(12)">How to Obtain</th>
                <th onclick="sortTable(13)">Own</th>
                <th colspan="2">Tyres Suspension</th>
                <th colspan="2">Diff Aero ECU Pwr</th>
                <th colspan="2">Tran Max Top SPD</th>
            </tr>
        </thead>
        <tbody id="car-table-body">
            <!-- Car data will be populated here by JavaScript -->
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadAllData();
        });

        // Fetches and parses a CSV file.
        async function fetchAndParseCSV(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to load ${url}`);
            const text = await response.text();
            
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                    return obj;
                }, {});
            });
        }

        // Main function to load all data and build the page
        async function loadAllData() {
            try {
                const [cars, manufacturers, countries, colors, stockperf] = await Promise.all([
                    fetchAndParseCSV('data/cars.csv'),
                    fetchAndParseCSV('data/maker.csv'),
                    fetchAndParseCSV('data/country.csv'),
                    fetchAndParseCSV('data/colors.csv'),
                    fetchAndParseCSV('data/stockperf.csv')
                ]);

                // Create maps for efficient data lookup
                const manufacturerMap = manufacturers.reduce((acc, m) => { acc[m.ID] = m; return acc; }, {});
                const countryMap = countries.reduce((acc, c) => { acc[c.ID] = c; return acc; }, {});
                const stockperfMap = stockperf.reduce((acc, p) => { acc[p.ID] = p; return acc; }, {});
                const colorMap = colors.reduce((acc, color) => {
                    if (!acc[color.CarID]) acc[color.CarID] = [];
                    acc[color.CarID].push(color.ColorName);
                    return acc;
                }, {});

                // Combine all data into a single array of car objects
                const combinedCarData = cars.map(car => {
                    const manufacturer = manufacturerMap[car.Maker];
                    const country = manufacturer ? countryMap[manufacturer.Country] : null;
                    const performance = stockperfMap[car.ID] || {};
                    const carColors = colorMap[car.ID] || [];
                    
                    return {
                        ...car,
                        MakeName: manufacturer ? manufacturer.Name : 'Unknown',
                        MakerCode: manufacturer ? manufacturer.Code : '',
                        CountryName: country ? country.Name : 'Unknown',
                        CountryCode: country ? country.Code : '??',
                        PP: performance.PP || '',
                        Tyres: performance.Tyre || '',
                        Colors: carColors
                    };
                });
                
                // Sort cars by Make to group them for headers
                combinedCarData.sort((a, b) => a.MakeName.localeCompare(b.MakeName) || a.ShortName.localeCompare(b.ShortName));

                buildHeaderTables(manufacturers, countries);
                populateCarTable(combinedCarData);
                runPostLoadScripts();

            } catch (error) {
                console.error("Error loading or processing data:", error);
                document.getElementById('car-table-body').innerHTML = `<tr><td colspan="20" style="text-align:center; color:red;">Error loading data. Check console.</td></tr>`;
            }
        }
        
        // Builds the manufacturer/country summary tables in the header
        function buildHeaderTables(manufacturers, countries) {
             // This function can be complex. For now, let's keep it simple or assume a predefined structure.
             // A full dynamic build would group manufacturers by country and generate the nested tables.
             // This is a placeholder to show where that logic would go.
             console.log("Header table generation would go here.");
        }

        // Populates the main table with car data
        function populateCarTable(carData) {
            const tbody = document.getElementById('car-table-body');
            tbody.innerHTML = ''; 

            let currentMake = '';
            carData.forEach((car, index) => {
                // Add a header row for each new manufacturer
                if (car.MakeName !== currentMake) {
                    currentMake = car.MakeName;
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `<th class="car-make-header" colspan="20">${currentMake}</th>`;
                    tbody.appendChild(headerRow);
                }

                // Create the car's data row
                const tr = document.createElement('tr');
                tr.id = car.ID;

                let colorsHtml = car.Colors.length > 0
                    ? car.Colors.map(color => `<p class="${car.MakerCode} ${car.CountryCode} z v">${color}</p>`).join('')
                    : `<p class="${car.MakerCode} ${car.CountryCode} z v">--</p>`;
                
                const ownClasses = `a ${car.MakerCode} ${car.CountryCode}`;

                // Note: Year, Layout, Aspiration, Prices, Tags, HowToObtain are missing from provided CSVs.
                // These will be left blank until added to cars.csv or another file.
                tr.innerHTML = `
                    <th>${index + 1}</th>
                    <td>${car.CountryCode}</td>
                    <td>${car.Year || ''}</td>
                    <td>${car.MakeName}</td>
                    <td>${car.ShortName}</td>
                    <td>${car.Layout || ''}</td>
                    <td>${car.Aspiration || ''}</td>
                    <td>${car.PP}</td>
                    <td class="price">${car.PriceNew || ''}</td>
                    <td class="price">${car.PriceLegend || ''}</td>
                    <td class="price">${car.PriceUsed || ''}</td>
                    <td>${car.Tags || ''}</td>
                    <td>${car.HowToObtain || ''}</td>
                    <td><div class="own-cell ${ownClasses}"></div>${colorsHtml}</td>
                    <td>Tyr<br>BHA<br>ARB<br>DRC<br>DRE<br>NaFr<br>NCA<br>Toe<br>BrB</td>
                    <td></td>
                    <td>InT<br>AcS<br>BrS<br>ToD<br>DoF<br>ECU<br>Bal<br>Pos<br>PoR</td>
                    <td></td>
                    <td>1st<br>2nd<br>3rd<br>4th<br>5th<br>6th<br>7th<br>8th<br>Fnl</td>
                    <td></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Helper and Original Functions ---

        function runPostLoadScripts() {
            addThousandSeparators();
            countClass();
            totals();
        }

        function addThousandSeparators() {
            const priceCells = document.querySelectorAll('.price');
            priceCells.forEach(cell => {
                let text = cell.textContent.trim();
                if (text && !isNaN(text)) {
                    cell.textContent = parseFloat(text).toLocaleString();
                }
            });
        }
        
        let lastSortedColumn = -1;
        let lastSortAscending = true;

        function sortTable(columnIndex) {
            const table = document.getElementById("main-table");
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.querySelectorAll('tr[id]')); // Only sort rows with an ID (car rows)
            
            const ascending = (lastSortedColumn === columnIndex) ? !lastSortAscending : true;

            rows.sort((a, b) => {
                const aVal = a.cells[columnIndex].textContent.trim().replace(/,/g, '');
                const bVal = b.cells[columnIndex].textContent.trim().replace(/,/g, '');
                
                const aIsNumber = !isNaN(parseFloat(aVal)) && isFinite(aVal);
                const bIsNumber = !isNaN(parseFloat(bVal)) && isFinite(bVal);

                if (aIsNumber && bIsNumber) {
                    return (ascending ? 1 : -1) * (parseFloat(aVal) - parseFloat(bVal));
                }
                return (ascending ? 1 : -1) * aVal.localeCompare(bVal, undefined, { numeric: true });
            });
            
            tbody.innerHTML = '';
            let currentMake = '';
            rows.forEach(row => {
                const makeName = row.cells[3].textContent;
                if (makeName !== currentMake) {
                    currentMake = makeName;
                    tbody.innerHTML += `<tr><th class="car-make-header" colspan="20">${currentMake}</th></tr>`;
                }
                tbody.appendChild(row);
            });
            
            lastSortedColumn = columnIndex;
            lastSortAscending = ascending;
        }
        
        function countClass() {
             const rows = document.querySelectorAll('#main-table tbody tr[id]');
             rows.forEach(row => {
                const zCount = row.querySelectorAll('.z').length;
                const vCount = row.querySelectorAll('.v').length;
                const ratio = zCount > 0 ? (vCount / zCount * 100) : 0;
                const div = row.querySelector('div.own-cell');
                if (div) {
                    div.className = 'own-cell ' + div.className; // Reset classes but keep original
                    if (vCount === 0) div.classList.add('n');
                    else {
                        div.classList.add('o');
                        if (zCount === vCount) div.classList.add('c');
                    }
                    div.textContent = ` [${zCount - vCount}] ${ratio.toFixed(0).padStart(3, '0')}% ${vCount}/${zCount}`;
                }
             });
        }
        
        function totals() {
            // This function remains complex and depends on the specific IDs in the header.
            // It will need the header to be built first. We'll leave it as is for now.
            // A more robust solution would be to calculate these totals from the data directly.
            console.log("Totals calculation running.");
        }

    </script>
</body>
</html>
